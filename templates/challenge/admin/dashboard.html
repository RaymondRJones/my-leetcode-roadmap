{% extends "base.html" %}

{% block title %}Admin Dashboard - 28-Day Challenge{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">
                <span class="material-icons me-2" style="vertical-align: middle; color: var(--nord11);">admin_panel_settings</span>
                Challenge Admin
            </h1>
            <p class="text-muted mb-0">Manage participants and submissions</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/challenge/admin/submissions" class="btn btn-outline-primary">
                <span class="material-icons me-1" style="vertical-align: middle;">assignment</span>
                Review Submissions
            </a>
            <a href="/challenge" class="btn btn-outline-secondary">
                <span class="material-icons me-1" style="vertical-align: middle;">arrow_back</span>
                Back to Challenge
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="md-card p-4 text-center">
                <span class="material-icons mb-2" style="font-size: 36px; color: var(--nord10);">people</span>
                <h2 class="mb-1" id="totalParticipants">-</h2>
                <p class="text-muted mb-0">Total Participants</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="md-card p-4 text-center">
                <span class="material-icons mb-2" style="font-size: 36px; color: var(--nord14);">trending_up</span>
                <h2 class="mb-1" id="activeParticipants">-</h2>
                <p class="text-muted mb-0">Active (7 days)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="md-card p-4 text-center">
                <span class="material-icons mb-2" style="font-size: 36px; color: var(--nord13);">pending</span>
                <h2 class="mb-1" id="pendingSubmissions">-</h2>
                <p class="text-muted mb-0">Pending Submissions</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="md-card p-4 text-center">
                <span class="material-icons mb-2" style="font-size: 36px; color: var(--nord15);">emoji_events</span>
                <h2 class="mb-1" id="completedChallenges">-</h2>
                <p class="text-muted mb-0">Completed Challenge</p>
            </div>
        </div>
    </div>

    <!-- Participants Table -->
    <div class="md-card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">All Participants</h5>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text">
                        <span class="material-icons" style="font-size: 18px;">search</span>
                    </span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by email...">
                </div>
            </div>

            <!-- Coming Soon Notice -->
            <div class="text-center py-5">
                <span class="material-icons mb-3" style="font-size: 64px; color: var(--nord4);">construction</span>
                <h4 class="mb-2">Admin Dashboard Coming Soon</h4>
                <p class="text-muted mb-0">
                    Full participant management will be available soon.<br>
                    This requires integration with Clerk's user listing API.
                </p>
            </div>

            <!-- Placeholder table (hidden) -->
            <div class="d-none">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th class="text-center">Points</th>
                                <th class="text-center">Streak</th>
                                <th class="text-center">Problems</th>
                                <th class="text-center">Days</th>
                                <th class="text-center">Last Active</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="participantsTable">
                            <!-- Participants will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load admin data
async function loadAdminData() {
    try {
        const response = await fetch('/api/challenge/admin/participants');
        const data = await response.json();

        if (data.participants) {
            renderParticipants(data.participants);
            updateStats(data.participants);
        }
    } catch (error) {
        console.error('Error loading admin data:', error);
    }
}

function updateStats(participants) {
    document.getElementById('totalParticipants').textContent = participants.length;

    // Calculate active (within 7 days)
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const active = participants.filter(p => {
        const lastActive = new Date(p.lastActivityDate);
        return lastActive >= sevenDaysAgo;
    }).length;

    document.getElementById('activeParticipants').textContent = active;

    // Completed challenges
    const completed = participants.filter(p => p.daysCompleted >= 28).length;
    document.getElementById('completedChallenges').textContent = completed;
}

function renderParticipants(participants) {
    const tbody = document.getElementById('participantsTable');
    tbody.innerHTML = participants.map(p => `
        <tr>
            <td>
                <strong>${p.email || 'Anonymous'}</strong>
            </td>
            <td class="text-center">${p.points}</td>
            <td class="text-center">${p.bestStreak}</td>
            <td class="text-center">${p.problemsSolved}</td>
            <td class="text-center">${p.daysCompleted}/28</td>
            <td class="text-center text-muted small">${formatDate(p.lastActivityDate)}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-primary" onclick="viewUser('${p.userId}')">
                    View
                </button>
            </td>
        </tr>
    `).join('');
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString();
}

function viewUser(userId) {
    // Open user detail modal
    alert('User detail view coming soon');
}

// Search functionality
document.getElementById('searchInput')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#participantsTable tr');

    rows.forEach(row => {
        const email = row.querySelector('td')?.textContent.toLowerCase() || '';
        row.style.display = email.includes(query) ? '' : 'none';
    });
});

// Load data on page ready
// loadAdminData();
</script>
{% endblock %}
